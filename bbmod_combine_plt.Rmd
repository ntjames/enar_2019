---
title: "Operating Characteristics of Bayesian Joint Benefit-Risk Copula Models plots"
subtitle: "Bivariate binary-binary outcome"
author: "Nathan T. James"
date: "<small>`r Sys.Date()`</small>"
output:
  html_document:
    toc: no
    toc_depth: 3
    number_sections: false
    toc_float:
      collapsed: false
    code_folding: hide
    theme: paper
code_folding: hide
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
#For code block want echo=TRUE if (knitr::is_html_output())
# echo=FALSE otherwise (e.g. echo = FALSE if (knitr::is_latex_output()))
knitr::opts_chunk$set(echo = knitr::is_html_output())
wdir<-file.path("/home/nathan/Dropbox/njames/school/PhD/misc/conferences/ENAR2019/code")
figdir<-file.path(wdir,"figs")

# load packages
libs<-c("copula", "knitr", "magrittr", "ggplot2", "rstan", "plotly", "bayesplot", "ggExtra", "polycor", "ggstance", "cowplot")
invisible(lapply(libs, library, character.only = TRUE))
```

## Read and process simulation data

### helper functions

```{r funs, cache=TRUE}

# calculate row differences
rowDiff <- function(mat){
  mat[,1] <- mat[,1]*-1
  return(rowSums(mat))
}

# calculate risk difference for efficacy and safety
getriskdiff <- function(s_id){
  
  # ind. model efficacy and safety risk difference
  assign("p_e_i_diff",rowDiff(get(paste0("samp_bb_e_",s_id))), pos = parent.frame())
  assign("p_s_i_diff",rowDiff(get(paste0("samp_bb_s_",s_id))), pos = parent.frame())
  
  # joint mod data
  samp_bb_jnt <- get(paste0("samp_bb_jnt_",s_id))
  
  # joint model efficacy and safety risk difference
  assign("p_e_j_diff", rowDiff(samp_bb_jnt[,c("p_e[1]","p_e[2]")]), pos = parent.frame())
  assign("p_s_j_diff", rowDiff(samp_bb_jnt[,c("p_s[1]","p_s[2]")]), pos = parent.frame())
  
}


# function to get credible interval from samples
ci_bb_sim <- function(s_id, qtile = c(0.05,0.5,0.95) ){
  
  # run helper to calculate risk diff for efficacy and safety
  getriskdiff(s_id)
  
  #! NB: order matters here because of labels
  diffs <- c("p_e_i_diff", "p_e_j_diff", "p_s_i_diff", "p_s_j_diff")
  diffs_ci <- lapply(diffs, function(x) quantile(get(x), qtile))
  diffs_ci_vec <- unlist(diffs_ci) 
  names(diffs_ci_vec) <- paste0(sort(rep(diffs,length(qtile))),"_q",qtile)
  
  return( c(s_id=s_id, diffs_ci_vec) )
}

# function to reshape combined output of ci_bb_sim
reshaper1 <- function(ds){
mlt0 <- reshape2::melt(ds, id.vars="s_id")
vars0 <- reshape2::colsplit(mlt0$variable,"_",names=c("p","outcome","mod","diff","qtile"))
mlt1 <- cbind(mlt0,vars0)
return(reshape2::dcast(mlt1, s_id+outcome+mod~qtile))
}


# function to get posterior probabilities of marginal events
pp_bb_sim <- function(s_id, grd = seq(0,1,by=0.01) ){
  
  # run helper to calculate risk diff for efficacy and safety
  getriskdiff(s_id)
  
  # posterior prob efficacy diff from ind model greater than g
  pp_e_i_gt <- sapply(grd,function(g) mean(p_e_i_diff > g)) 
  
  # posterior prob safety diff from ind model greater than g
  pp_s_i_gt <- sapply(grd,function(g) mean(p_s_i_diff > g))
  
  # posterior prob efficacy diff from joint copula model greater than g
  pp_e_j_gt <- sapply(grd,function(g) mean(p_e_j_diff > g))
  
  # posterior prob safety diff from joint copula model greater than g
  pp_s_j_gt <- sapply(grd,function(g) mean(p_s_j_diff > g))

  #! NB: order matters here because of labels
  postps <- c("pp_e_i_gt", "pp_e_j_gt", "pp_s_i_gt", "pp_s_j_gt")
  postps_ls <- lapply(postps, function(x) get(x))
  postps_vec <- unlist(postps_ls) 
  
  names(postps_vec) <- paste0(sort(rep(postps,length(grd))),"_g_",grd)
  
  c(s_id=s_id,postps_vec)
}

# function to reshape combined output of pp_bb_sim
reshaper2 <- function(ds){
mlt0 <- reshape2::melt(ds, id.vars="s_id", value.name="pp_gt_g")
vars0 <- reshape2::colsplit(mlt0$variable,"_",names=c("pp","outcome","mod","foo","bar","g"))
mlt1 <- cbind(mlt0,vars0)
return(mlt1[,c("s_id","outcome","mod","g","pp_gt_g")])
}


# function to get posterior probabilities of joint outcome
pp_jnt_bb_sim <- function(s_id, grd = seq(0,1,by=0.01) ){
  
  # run helper to calculate risk diff for efficacy and safety
  getriskdiff(s_id)
  
  # joint posterior prob of:
  #   efficacy diff from ind model greater than g AND
  #   safety diff from ind model greater than g
  pp_jnt_i_gt <- sapply(grd,function(g) mean(p_e_i_diff > g & p_s_i_diff > g)) 
  
  # joint posterior prob of:
  #   efficacy diff from copula model greater than g AND
  #   safety diff from copula model greater than g
  pp_jnt_j_gt <- sapply(grd,function(g) mean(p_s_j_diff > g & p_e_j_diff > g))

  #! order matters here because of labels
  postps <- c("pp_jnt_i_gt", "pp_jnt_j_gt")
  postps_ls <- lapply(postps , function(x) get(x))
  postps_vec <- unlist(postps_ls) 
  
  names(postps_vec) <- paste0(sort(rep(postps, length(grd))),"_g_",grd)
  
  c(s_id=s_id,postps_vec)
}

# function to reshape combined output of pp_jnt_bb_sim
reshaper3 <- function(ds){
mlt0 <- reshape2::melt(ds, id.vars="s_id", value.name="pp_gt_g")
vars0 <- reshape2::colsplit(mlt0$variable,"_",names=c("pp","jnt","mod","foo","bar","g"))
mlt1 <- cbind(mlt0,vars0)
return(mlt1[,c("s_id","jnt","mod","g","pp_gt_g")])
}


# function to get correlation between posterior efficacy risk diff and safety risk diff
corr_bb_sim <- function(s_id){
  
  # run helper to calculate risk diff for efficacy and safety
  getriskdiff(s_id)
  
  # correlation between posterior for 
  # efficacy risk diff and safety risk diffs from independence model
  corr_i <- cor(p_e_i_diff, p_s_i_diff) 
  
  # correlation between posterior for 
  # efficacy risk diff and safety risk diffs from copula model
  corr_j <- cor(p_e_j_diff, p_s_j_diff) 
  
  c(s_id=s_id,corr_ind = corr_i, corr_jnt=corr_j)
}

# function to reshape combined output of pp_jnt_bb_sim
reshaper4 <- function(ds){
mlt0 <- reshape2::melt(ds, id.vars="s_id", value.name="corr")
vars0 <- reshape2::colsplit(mlt0$variable,"_",names=c("corr","mod"))
mlt1 <- cbind(mlt0,vars0)
return(mlt1[,c("s_id","mod","corr")])
}


#tmp<- seq(0,1,by=0.1)
#expand.grid(tmp,tmp)

#load(file.path(wdir,"sims","bb",paste0("bb_sim_",1,".RData")), .GlobalEnv)
#load(file.path(wdir,"sims","bb",paste0("bb_sim_",2,".RData")), .GlobalEnv)

# prob of technical success 
pots <- function(delta_e, delta_p, dat=diffs){
  
  pots0 <- function(delta_e, delta_p, dat){
    mean(dat[,1]>=delta_e & dat[,2]<=delta_p)*100
  }
  
  #vectorize
  mapply(function(x,y) pots0(x,y,dat), delta_e, delta_p)
}

#de<-seq(70,130,length=50)
#ds<-seq(0,0.5,length=50)
#pp<-outer(de,ds,pots)
#pp0<-outer(de,ds,pots,dat=diffs0)

g_seq <- seq(0,1,by=0.05)

# function to get prob of technical success given sim_id
pots_bb_sim <- function(s_id, grd = g_seq){
  
  # run helper to calculate risk diff for efficacy and safety
  getriskdiff(s_id)
  
  diffs_i <- cbind(p_e_i_diff,p_s_i_diff)
  diffs_j <- cbind(p_e_j_diff,p_s_j_diff)
  
  pots_i <- outer(grd, grd, pots, dat=diffs_i)
  pots_j <- outer(grd, grd, pots, dat=diffs_j)

  pots_labs <- c("pots_i", "pots_j")
  pots_vec <- c(pots_i,pots_j)

  grd2<-expand.grid(grd,grd)
  grd_nms<-paste0(grd2[,1],"_",grd2[,2])
  names(pots_vec)<-paste0(sort(rep(pots_labs, length(grd)^2 )),"_g_",grd_nms)
  
  c(s_id=s_id, pots_vec)
}

# function to reshape combined output of pots_bb_sim
reshaper5 <- function(ds){
mlt0 <- reshape2::melt(ds, id.vars="s_id", value.name="pots_g")
vars0 <- reshape2::colsplit(mlt0$variable,"_",names=c("pots","mod","g","g_e","g_s"))
mlt1 <- cbind(mlt0,vars0)
return(mlt1[,c("s_id","mod","g_e","g_s","pots_g")])
}


# function to read in and process simulation data in batches 
# (since all data cannot fit in memory at once)
# batches are deleted after loading
doBatch <- function(all_sim_ids, batchsize){
  
  sim_ids_split <- split(all_sim_ids, ceiling(seq_along(all_sim_ids)/batchsize))
  batches <- length(sim_ids_split)
  
  for (i in 1:batches){
    
    sims_in_batch <- sim_ids_split[[i]] 
    
    for (j in seq_along(sims_in_batch)){
      # load data
      s_id <- sims_in_batch[j]
      load(file.path(wdir,"sims","bb",paste0("bb_sim_",s_id,".RData")), .GlobalEnv)
    }
    
    # print(sims_in_batch) # for debugging
    
    # ci_bb_sim for batch - credible intervals
    assign(paste0("bb_ci_dat0_",i),
         data.frame(do.call(rbind, lapply(sims_in_batch, ci_bb_sim))),
         envir=.GlobalEnv)
    
    # pp_bb_sim for batch - separate posterior probs >= grid value
    assign(paste0("bb_pp_dat0_",i),
             data.frame(do.call(rbind, lapply(sims_in_batch, pp_bb_sim))),
             envir=.GlobalEnv)
    
    # pp_jnt_bb_sim for batch - joint posterior probs >= grid value
    assign(paste0("bb_pp_jnt_dat0_",i),
             data.frame(do.call(rbind, lapply(sims_in_batch, pp_jnt_bb_sim))),
             envir=.GlobalEnv)
    
    # pots_bb_sim for batch - prob of technical success
    assign(paste0("bb_pots_dat0_",i),
             data.frame(do.call(rbind, lapply(sims_in_batch, pots_bb_sim))),
             envir=.GlobalEnv)
    
    # corr_bb_sim for batch - correlation between posterior probs
    assign(paste0("bb_corr_dat0_",i),
           data.frame(do.call(rbind, lapply(sims_in_batch, corr_bb_sim))),
           envir=.GlobalEnv)
    
    # remove loaded datasets, samples, summaries and sim params for batch
    rm(list=ls(envir=.GlobalEnv)[grep("dat_bb_|samp_bb_|summ_bb_|sim_params_",
                                      ls(envir=.GlobalEnv))], envir=.GlobalEnv)
  }
  
}

```

### Read in array with simulation parameters and list of simulation datasets

```{r preprocess, cache=TRUE}
# read in array with simulation parameters
bb_sim_array <- readRDS(file.path(wdir,"bb_sim_array.rds"))
bb_sim_array_ord <- bb_sim_array[order(bb_sim_array$n,
                                       bb_sim_array$rho_2,
                                       bb_sim_array$p_e2,
                                       bb_sim_array$p_s2,
                                       bb_sim_array$rep_id),]

# add scenario id to bb_sim_array_ord
nreps <- 100
nscn <- nrow(bb_sim_array)/nreps
sc_id <- sort(rep(1:nscn,nreps))
bb_sim_array_ord$scn_id <- sc_id


# list of simulation files
bb_sim_files <- dir(file.path(wdir,"sims","bb"), pattern=".RData")
bb_sim_files_num0 <- substr(bb_sim_files,8,50)
bb_sim_files_num <- as.numeric(do.call(rbind,strsplit(bb_sim_files_num0,".R"))[,1])

bb_sim_array_ord_run <- subset(bb_sim_array_ord, sim_id %in% bb_sim_files_num)
rm(bb_sim_array, bb_sim_array_ord, bb_sim_files_num0, nreps, nscn, sc_id)

# placebo group vals
p_e1 <- 0.2 # prob effective
p_s1 <- 0.1 # prob AE
rho_1 <- 0.1 # tetrachoric correlation, can estimate with polycor::polychor
```

### Process simulation datasets in batches

```{r batch_process, cache=TRUE}
# load and process sims in batches
bsize <- 300

#doBatch(bb_sim_files_num[1:500], 100)
doBatch(bb_sim_files_num, bsize)
```

### Combine all batches 

```{r batch_postprocess, cache=TRUE}
bb_ci_vec <- ls()[grep("bb_ci_dat0_",ls())]
bb_ci_dat0 <- do.call(rbind,sapply(bb_ci_vec, get,simplify = FALSE))
bb_ci_dat1 <- reshaper1(bb_ci_dat0)
bb_ci_dat <- merge(bb_sim_array_ord_run, bb_ci_dat1, by.x="sim_id",by.y="s_id")
rm(list=bb_ci_vec)
rm(bb_ci_dat0, bb_ci_vec)

bb_pp_vec <- ls()[grep("bb_pp_dat0_",ls())]
bb_pp_dat0 <- do.call(rbind, sapply(bb_pp_vec, get,simplify = FALSE) )
bb_pp_dat1 <- reshaper2(bb_pp_dat0)
bb_pp_dat <- merge(bb_sim_array_ord_run, bb_pp_dat1, by.x="sim_id",by.y="s_id")
rm(list=bb_pp_vec)
rm(bb_pp_dat0, bb_pp_vec)

bb_pp_jnt_vec <- ls()[grep("bb_pp_jnt_dat0_",ls())]
bb_pp_jnt_dat0 <- do.call(rbind, sapply(bb_pp_jnt_vec, get,simplify = FALSE) )
bb_pp_jnt_dat1 <- reshaper3(bb_pp_jnt_dat0)
bb_pp_jnt_dat <- merge(bb_sim_array_ord_run, bb_pp_jnt_dat1, by.x="sim_id",by.y="s_id")
rm(list=bb_pp_jnt_vec)
rm(bb_pp_jnt_dat0, bb_pp_jnt_vec)

bb_corr_vec<-ls()[grep("bb_corr_dat0_",ls())]
bb_corr_dat0<-do.call(rbind, sapply(bb_corr_vec, get,simplify = FALSE) )
bb_corr_dat1 <- reshaper4(bb_corr_dat0)
bb_corr_dat<-merge(bb_sim_array_ord_run, bb_corr_dat1, by.x="sim_id",by.y="s_id")
rm(list=bb_corr_vec)
rm(bb_corr_dat0, bb_corr_vec)

bb_pots_vec <- ls()[grep("bb_pots_dat0_",ls())]
bb_pots_dat0 <- do.call(rbind, sapply(bb_pots_vec, get,simplify = FALSE) )
bb_pots_dat1 <- reshaper5(bb_pots_dat0)
bb_pots_dat <- merge(bb_sim_array_ord_run, bb_pots_dat1, by.x="sim_id",by.y="s_id")
rm(list=bb_pots_vec)
rm(bb_pots_dat0, bb_pots_vec)
```

## Plots of credible intervals

### Credible intervals

Plots of the raw credible intervals are similar for the joint bivariate copula model and the independent univariate models. The joint model intervals that are much wider seem to occur when the underlying Bayesian copula model fails to converge. 

```{r bb-ci-plt, fig.height=8, fig.width=14}

# better labels for risk differences, models, outcome
bb_ci_dat_cln <- bb_ci_dat %>% mutate(delta_e=p_e2-p_e1, delta_s=p_s2-p_s1, 
                      model = factor(mod,c("i","j"), c("independent","copula")),
                      outcome = factor(outcome, c("e","s"), c("efficacy","safety")))

bb_ci_n100_1 <- ggplot(data=subset(bb_ci_dat_cln, rho_2==0.1 & n==100),
            aes(x=q0.5, xmin=q0.05, xmax=q0.95, y=outcome, color=model)) +   
          geom_linerangeh(position=position_dodgev(height=0.4), size=2, alpha=0.15) +
          facet_grid(delta_e~delta_s, labeller = "label_both") + 
          theme(legend.position = "none")

bb_ci_n100_2 <- ggplot(data=subset(bb_ci_dat_cln, rho_2==0.35 & n==100), 
            aes(x=q0.5, xmin=q0.05, xmax=q0.95, y=outcome, color=model)) +   
          geom_linerangeh(position=position_dodgev(height=0.4), size=2, alpha=0.15) +
          facet_grid(delta_e~delta_s, labeller = "label_both") + 
          theme(legend.position = "none")

bb_ci_n100_3 <- ggplot(data=subset(bb_ci_dat_cln, rho_2==0.6 & n==100), 
            aes(x=q0.5, xmin=q0.05, xmax=q0.95, y=outcome, color=mod)) +   
          geom_linerangeh(position=position_dodgev(height=0.4), size=2, alpha=0.15) +
          facet_grid(delta_e~delta_s, labeller = "label_both") + 
          theme(legend.position = "none")

bb_ci_n100 <- plot_grid(bb_ci_n100_1, bb_ci_n100_2, bb_ci_n100_3,
                      labels=c("rho_2=0.1","rho_2=0.35","rho_2=0.6"), 
                      rel_widths=c(1,1,1.4), scale=0.85, label_size=11) 

bb_ci_n100

# date & time tag
#dt <- gsub("\\.","_",make.names(Sys.time()))
#bb_ci_plt <- paste0("bb_ci_n100_plt_",dt,".png")

bb_ci_plt <- "bb_ci_n100_plt.png"

png(file.path(figdir,bb_ci_plt), width=1800, height=600, pointsize=5)
bb_ci_n100
dev.off()
```

### Credible interval widths

## Mean credible interval widths

Since some of the joint copula model simulations didn't converge (and therefore had very large interval widths) using the mean interval width will give the impression that the joint model is *less* efficient than the independent model. Instead, we can use median interval width which will mitigate the effect of these outliers to some degree.

```{r bb-ci-widths-mean-plt, eval=FALSE}
bb_ci_dat_summ <- bb_ci_dat_cln %>% 
  select(-c(dat_seed, samp_seed, mod)) %>% 
  arrange(scn_id,rep_id) %>% 
  mutate(ci_width = q0.95 - q0.05) %>%
  group_by(scn_id, outcome, model) %>%
  summarise(mean_ci_width = mean(ci_width), n=mean(n), rho_2=mean(rho_2), delta_e=mean(delta_e),delta_s=mean(delta_s))

bb_ci_dat_summ2 <- bb_ci_dat_summ %>% mutate(delta_e=factor(delta_e,c(0,0.3,0.6), c("delta[e]==0","delta[e]==0.3","delta[e]==0.6")),
      delta_s=factor(delta_s,c(0,0.3,0.6), c("delta[s]==0","delta[s]==0.3","delta[s]==0.6")))    

if(0){
ggplot(data=subset(bb_ci_dat_summ,rho_2==0.1 & n==400),
       aes(x=mean_ci_width, y=outcome, color=model)) +   
   geom_point(aes(shape=model), size=2, position=position_dodgev(height=0.4), alpha=0.75) +
    facet_grid(delta_e~delta_s,labeller = "label_both")
  
ggplot(data=subset(bb_ci_dat_summ,rho_2==0.35 & n==400),
       aes(x=mean_ci_width, y=outcome, color=model)) +   
   geom_point(aes(shape=model), size=2, position=position_dodgev(height=0.4), alpha=0.75) +
    facet_grid(delta_e~delta_s,labeller = "label_both")

ggplot(data=subset(bb_ci_dat_summ,rho_2==0.6 & n==400),
       aes(x=mean_ci_width, y=outcome, color=model)) +   
   geom_point(aes(shape=model), size=2, position=position_dodgev(height=0.4), alpha=0.75) +
    facet_grid(delta_e~delta_s,labeller = "label_both")

bb_ciw_r01 <- ggplot(data=subset(bb_ci_dat_summ,rho_2==0.1),
       aes(x=mean_ci_width, y=outcome, color=model)) +   
   geom_point(aes(size=n), position=position_dodgev(height=0.4), alpha=0.5) +
    facet_grid(delta_e~delta_s,labeller = "label_both") 
#+ theme(legend.position = "none")
  
bb_ciw_r035 <- ggplot(data=subset(bb_ci_dat_summ,rho_2==0.35 ),
       aes(x=mean_ci_width, y=outcome, color=model)) +   
   geom_point(aes(size=n), position=position_dodgev(height=0.4), alpha=0.5) +
    facet_grid(delta_e~delta_s,labeller = "label_both") 

bb_ciw_r06 <-ggplot(data=subset(bb_ci_dat_summ, rho_2==0.6),
       aes(x=mean_ci_width, y=outcome, color=model)) +   
   geom_point(aes(size=n), position=position_dodgev(height=0.4), alpha=0.5) +
    facet_grid(delta_e~delta_s, labeller = "label_parsed")


bb_ciw <- plot_grid(bb_ciw_r01, bb_ciw_r035, bb_ciw_r06, ncol=3,
                      labels=c("rho_2=0.1","rho_2=0.35","rho_2=0.6"), 
                      rel_widths=c(1,1,1.4), scale=0.85, label_size=11) 
}

bb_ciw_r01 <-ggplot(data=subset(bb_ci_dat_summ2, rho_2==0.1),
       aes(x=mean_ci_width, y=outcome, color=model)) +   
   geom_point(aes(size=n), position=position_dodgev(height=0.4), alpha=0.5) +
    facet_grid(delta_e~delta_s, labeller = "label_parsed") + 
   labs(x="mean width of 90% posterior credible interval") +
   theme(legend.position = "none")

bb_ciw_r035 <-ggplot(data=subset(bb_ci_dat_summ2, rho_2==0.35),
       aes(x=mean_ci_width, y=outcome, color=model)) +   
   geom_point(aes(size=n), position=position_dodgev(height=0.4), alpha=0.5) +
    facet_grid(delta_e~delta_s, labeller = "label_parsed") + 
   labs(x="mean width of 90% posterior credible interval") +
   theme(legend.position = "none")
   
bb_ciw_r06 <-ggplot(data=subset(bb_ci_dat_summ2, rho_2==0.6),
       aes(x=mean_ci_width, y=outcome, color=model)) +   
   geom_point(aes(size=n), position=position_dodgev(height=0.4), alpha=0.5) +
    facet_grid(delta_e~delta_s, labeller = "label_parsed") + 
   labs(x="mean width of 90% posterior credible interval")

# plot shows average 90% quantile posterior credible interval widths for independent and copula models across a range of true efficacy and safety risk differences and sample sizes
bb_ciwidths_sub_plt <- plot_grid(bb_ciw_r01, bb_ciw_r035, bb_ciw_r06, ncol=3,
                      labels= paste("rho_t =",c(0.1,0.35,0.6)) , 
                      rel_widths=c(1,1,1.4), scale=0.85, label_size=11) 

dt <- gsub("\\.","_",make.names(Sys.time()))
bb_ciw_subplt <- paste0("bb_ciwidths_sub_plt_",dt,".png")

png(file.path(figdir,bb_ciw_subplt), width=1800, height=600, pointsize=5)
bb_ciwidths_sub_plt # <-- output for poster?
dev.off()
```

## Median credible interval widths

For most scenarios, the credible interval widths for the joint copula model are the same size or smaller than independent model credible interval widths. An exception is the somewhat extreme scenario with $\rho_t=0.6$, $\delta_s=0.6$ and $\delta_e=0$ which posits a large correlation between the safety and efficacy outcome for the treated group, a large safety risk difference, but no efficacy risk difference. 

```{r bb-ci-widths-median-plt, fig.height=6, fig.width=16}
bb_ci_dat_med_summ <- bb_ci_dat_cln %>% 
  select(-c(dat_seed, samp_seed, mod)) %>% 
  arrange(scn_id,rep_id) %>% 
  mutate(ci_width = q0.95 - q0.05) %>%
  group_by(scn_id, outcome, model) %>%
  summarise(med_ci_width = median(ci_width), n=median(n), rho_2=median(rho_2), delta_e=median(delta_e),delta_s=median(delta_s))

bb_ci_dat_med_summ2 <- bb_ci_dat_med_summ %>% mutate(delta_e=factor(delta_e,c(0,0.3,0.6), c("delta[e]==0","delta[e]==0.3","delta[e]==0.6")),
      delta_s=factor(delta_s,c(0,0.3,0.6), c("delta[s]==0","delta[s]==0.3","delta[s]==0.6")))    

# horizontal dodge amount
dodgeamt<-0.4
# dodgeamt<-0

bb_mdciw_r01 <-ggplot(data=subset(bb_ci_dat_med_summ2, rho_2==0.1),
       aes(x=med_ci_width, y=outcome, color=model)) +   
   geom_point(aes(size=n), position=position_dodgev(height=dodgeamt), alpha=0.5) +
    facet_grid(delta_e~delta_s, labeller = "label_parsed") + 
  scale_color_brewer(palette="Set1") + 
   labs(x="median width of 90% posterior credible interval") +
   theme(legend.position = "none")

bb_mdciw_r035 <-ggplot(data=subset(bb_ci_dat_med_summ2, rho_2==0.35),
       aes(x=med_ci_width, y=outcome, color=model)) +   
   geom_point(aes(size=n), position=position_dodgev(height=dodgeamt), alpha=0.5) +
    facet_grid(delta_e~delta_s, labeller = "label_parsed") + 
  scale_color_brewer(palette="Set1") + 
   labs(x="median width of 90% posterior credible interval") +
   theme(legend.position = "none")
   
bb_mdciw_r06 <-ggplot(data=subset(bb_ci_dat_med_summ2, rho_2==0.6),
       aes(x=med_ci_width, y=outcome, color=model)) +   
   geom_point(aes(size=n), position=position_dodgev(height=dodgeamt), alpha=0.5) +
    facet_grid(delta_e~delta_s, labeller = "label_parsed") + 
  scale_color_brewer(palette="Set1") + 
   labs(x="median width of 90% posterior credible interval")

# plot shows median 90% quantile posterior credible interval widths for independent and copula models across a range of true efficacy and safety risk differences and sample sizes
bb_mdciwidths_sub_plt <- plot_grid(bb_mdciw_r01, bb_mdciw_r035, bb_mdciw_r06, ncol=3,
                      labels= paste("rho_t =",c(0.1,0.35,0.6)) , 
                      rel_widths=c(1,1,1.4), scale=0.85, label_size=11) 

bb_mdciwidths_sub_plt

# add date tag
#dt <- gsub("\\.","_",make.names(Sys.time()))
#bb_mdciw_subplt <- paste0("bb_mdciwidths_sub_plt_",dt,".png")

bb_mdciw_subplt <- "bb_mdciwidths_sub_plt.png"

png(file.path(figdir,bb_mdciw_subplt), width=1800, height=600, pointsize=5)
bb_mdciwidths_sub_plt
dev.off()
```

In addition, we can summarize over the scenarios to look at overall trends in credible interval width between the joint copula model and the independent models. The large degree of overlap indicates minimal efficiency gains from fitting the joint model to bivariate binary-binary outcomes.

```{r bb-ci-widths-overall-mean-plt, eval=FALSE}
# summarize over subgroups of different delta_e and delta_s
bb_ci_dat_s <- bb_ci_dat_cln %>% 
  select(-c(dat_seed, samp_seed, mod, p_e2, p_s2)) %>% 
  arrange(scn_id,rep_id) %>% 
  mutate(ci_width = q0.95 - q0.05) %>%
  group_by(n, rho_2, outcome, model) %>%
  summarise(mean_ci_width = mean(ci_width))

bb_ci_dat_s2 <- bb_ci_dat_s %>% ungroup() %>% mutate(rho_2=factor(rho_2,c(0.1,0.35,0.6),c("rho[t]==0.1","rho[t]==0.35","rho[t]==0.6")))      
# plot shows average 90% quantile posterior credible interval widths for independent and copula models across a range of treatment group outcome correlations and sample sizes
bb_ciwidths_plt <- ggplot(data=subset(bb_ci_dat_s2), 
                      aes(x=mean_ci_width, y=outcome, color=model)) + 
               geom_point(aes(size=n), position=position_dodgev(height=0.4), alpha=0.5) +
               xlim(c(0.05,0.3)) +
               scale_size_continuous(range = c(5, 10), breaks=c(0,50,100,200,400)) +
               facet_grid(.~rho_2, labeller = "label_parsed") + 
               labs(x="mean width of 90% posterior credible interval") +
               guides(color = guide_legend(override.aes = list(size = 5)))

bb_ciwidths_plt # <-- output for poster


my_thm <- list(theme(legend.title = element_text(size=30),
                    plot.title = element_text(size=30),
                    axis.title = element_text(size=25),
                    axis.text.y = element_text(size=20),
                    axis.text.x = element_text(size=18),
                    strip.text.x = element_text(size=20),
                    legend.text = element_text(size=20),
                    panel.spacing.x = unit(5.0, "lines") ) )


png(file.path(figdir,"bb_ciwidths_plt.png"), width=900, height=600, pointsize=5)
bb_ciwidths_plt + my_thm
dev.off()
```

```{r bb-ci-widths-overall-median-plt, fig.height=4, fig.width=10}
# summarize over subgroups of different delta_e and delta_s
bb_mdci_dat_s <- bb_ci_dat_cln %>% 
  select(-c(dat_seed, samp_seed, mod, p_e2, p_s2)) %>% 
  arrange(scn_id,rep_id) %>% 
  mutate(ci_width = q0.95 - q0.05) %>%
  group_by(n, rho_2, outcome, model) %>%
  summarise(med_ci_width = median(ci_width))

bb_mdci_dat_s2 <- bb_mdci_dat_s %>% ungroup() %>% mutate(rho_2=factor(rho_2,c(0.1,0.35,0.6),c("rho[t]==0.1","rho[t]==0.35","rho[t]==0.6")))      
# plot shows median 90% quantile posterior credible interval widths for independent and copula models across a range of treatment group outcome correlations and sample sizes
bb_mdciwidths_plt <- ggplot(data=subset(bb_mdci_dat_s2), 
                      aes(x=med_ci_width, y=outcome, color=model)) + 
               geom_point(aes(size=n), position=position_dodgev(height=0.4), alpha=0.5) +
               xlim(c(0.05,0.3)) +
               scale_size_continuous(range = c(5, 10), breaks=c(0,50,100,200,400)) +
               facet_grid(.~rho_2, labeller = "label_parsed") + 
               labs(x="median width of 90% posterior credible interval") +
               guides(color = guide_legend(override.aes = list(size = 5)))


# without horizontal displacement
bb_mdciwidths_plt <- ggplot(data=subset(bb_mdci_dat_s2), 
                      aes(x=med_ci_width, y=outcome, color=model)) + 
               geom_point(aes(size=n), alpha=0.6) +
               xlim(c(0.05,0.3)) +
               scale_size_continuous(range = c(5, 10), breaks=c(0,50,100,200,400)) +
               facet_grid(.~rho_2, labeller = "label_parsed") +
               scale_color_brewer(palette="Set1") + 
               labs(x="median width of 90% posterior credible interval") +
               guides(color = guide_legend(override.aes = list(size = 5)))
  

bb_mdciwidths_plt # <-- output for poster

my_thm <- list(theme(legend.title = element_text(size=30),
                    plot.title = element_text(size=30),
                    axis.title = element_text(size=25),
                    axis.text.y = element_text(size=20),
                    axis.text.x = element_text(size=18),
                    strip.text.x = element_text(size=20),
                    legend.text = element_text(size=20),
                    panel.spacing.x = unit(5.0, "lines") ) )


png(file.path(figdir,"bb_mdciwidths_plt.png"), width=900, height=600, pointsize=5)
bb_mdciwidths_plt + my_thm
dev.off()
```


## Plots of separate posterior probs greater than g
```{r bb-pp-plt, fig.align="center"}
# make better labels for risk differences, models, outcome
bb_pp_dat_cln <- bb_pp_dat %>% mutate(delta_e=p_e2-p_e1, delta_s=p_s2-p_s1, 
                      model = factor(mod,c("i","j"), c("independent","copula")),
                      outcome = factor(outcome, c("e","s"), c("efficacy","safety"))) %>%
                  select(-c(dat_seed,samp_seed,mod,p_e2,p_s2)) 

ggplot(data=subset(bb_pp_dat_cln,rho_2==0.35 & n==200 & model=="copula"), 
       aes(x=g, y=pp_gt_g, color=outcome, group=interaction(outcome,rep_id))) + 
  geom_line(alpha=0.4) + facet_grid(delta_e~delta_s,labeller = "label_both") + #theme(legend.position = "none", axis.text.x= element_text(size=10))+
  theme(axis.text.x= element_text(size=10))+
  ggtitle("MCMC draws of Posterior prob. outcome > g from copula model", 
          subtitle="n=200, rho_2=0.35") + ylab("posterior prob. outcome > g")


bb_pp_dat_summ <- bb_pp_dat_cln %>% 
  arrange(scn_id, outcome, model, g) %>%
  group_by(scn_id, outcome, model, g) %>%
  summarise(mean_pp_gt_g = mean(pp_gt_g), n=mean(n), rho_2=mean(rho_2), delta_e=mean(delta_e),delta_s=mean(delta_s))


ggplot(data=subset(bb_pp_dat_summ, rho_2==0.35 & n==200 & outcome=="efficacy"), 
       aes(x=g, y=mean_pp_gt_g, color=model, group=model)) + 
  geom_line(alpha=0.5) + facet_grid(delta_e~delta_s,labeller = "label_both") +
  ggtitle("Mean posterior prob. of p_efficacy > g", subtitle="n=200, rho_2=0.35") +
  ylab("mean posterior prob. p_efficacy > g")

ggplot(data=subset(bb_pp_dat_summ, rho_2==0.35 & n==200 & outcome=="safety"), 
       aes(x=g, y=mean_pp_gt_g, color=model, group=model)) + 
  geom_line(alpha=0.5) + facet_grid(delta_e~delta_s,labeller = "label_both") +
  ggtitle("Mean posterior prob. of p_safety > g", subtitle="n=200, rho_2=0.35") +
  ylab("mean posterior prob. p_safety > g")

# get difference in posterior prob of being greater than g for eff and safety
sub1_bb_pp_dat_summ<-subset(bb_pp_dat_summ, model=="independent") %>% rename(mn_pp_gt_g_i=mean_pp_gt_g)
sub2_bb_pp_dat_summ<-subset(bb_pp_dat_summ, model=="copula") %>% rename(mn_pp_gt_g_j=mean_pp_gt_g)

bb_pp_dat_summ_diff<-merge(sub1_bb_pp_dat_summ, sub2_bb_pp_dat_summ, by=c("scn_id", "g", "n", "rho_2", "delta_e", "delta_s","outcome")) %>% mutate(mn_pp_gt_g_diff=mn_pp_gt_g_i-mn_pp_gt_g_j)

ggplot(data=subset(bb_pp_dat_summ_diff, n==400 & outcome=="safety"), 
       aes(x=mn_pp_gt_g_i, y=mn_pp_gt_g_j, color=factor(rho_2), group=factor(rho_2) )) + 
  geom_line(alpha=0.5) + facet_grid(delta_e~delta_s,labeller = "label_both") +
  ggtitle("Mean posterior prob. of p_safety > g", subtitle="joint copula model vs. independent models, n=400") +
  xlab("mean posterior prob. p_safety > g (independent model)") +
  ylab("mean posterior prob. p_safety > g (copula model)")

ggplot(data=subset(bb_pp_dat_summ_diff, n==400 & outcome=="efficacy"), 
       aes(x=mn_pp_gt_g_i, y=mn_pp_gt_g_j, color=factor(rho_2), group=factor(rho_2) )) + 
  geom_line(alpha=0.5) + facet_grid(delta_e~delta_s,labeller = "label_both") +
  ggtitle("Mean posterior prob. of p_efficacy > g", subtitle="joint copula model vs. independent models, n=400") +
  xlab("mean posterior prob. p_efficacy > g (independent model)") +
  ylab("mean posterior prob. p_efficacy > g (copula model)")

```

```{r, eval=FALSE}
bb_pp_dat_srt <- bb_pp_dat %>% arrange(rep_id,outcome,mod,g)
#ss<-subset(bb_pp_dat,scn_id==72)
#table(ss$mod,ss$outcome,ss$rep_id)

if (0){
ggplot(data=subset(bb_pp_dat_srt,scn_id==72 & rep_id==99), 
       aes(x=g, y=pp_gt_g, linetype=outcome)) + geom_line(aes(col=mod))

ggplot(data=subset(bb_pp_dat,scn_id==72 & rep_id==97), 
       aes(x=g, y=pp_gt_g, linetype=outcome)) + geom_line(aes(col=mod))

ggplot(data=subset(bb_pp_dat,scn_id==72), aes(x=g, y=pp_gt_g, group=rep_id)) + geom_line(alpha=0.5) + facet_grid(mod~outcome)

ggplot(data=subset(bb_pp_dat,scn_id==72), 
       aes(x=g, y=pp_gt_g, color=mod, group=interaction(mod,rep_id))) + 
  geom_line(alpha=0.5) + facet_grid(outcome~.)
}

ggplot(data=subset(bb_pp_dat,scn_id==3 & rep_id==37), 
       aes(x=g, y=pp_gt_g, linetype=outcome)) + geom_line(aes(col=mod))

png(file.path(figdir,"bb_pp_scn3_r5.png"),width=720,height=720)
ggplot(data=subset(bb_pp_dat,scn_id==3 & rep_id==5), 
       aes(x=g, y=pp_gt_g, linetype=outcome)) + geom_line(aes(col=mod))
dev.off()

ggplot(data=subset(bb_pp_dat,scn_id==3), aes(x=g, y=pp_gt_g, group=rep_id)) + geom_line(alpha=0.5) + facet_grid(mod~outcome)

# 
png(file.path(figdir,"bb_pp_scn3.png"),width=720,height=720)
ggplot(data=subset(bb_pp_dat,scn_id==3), 
       aes(x=g, y=pp_gt_g, color=mod, group=interaction(mod,rep_id))) + 
  geom_line(alpha=0.5) + facet_grid(.~outcome)
dev.off()


ggplot(data=subset(bb_pp_dat,scn_id==3), 
       aes(x=g, y=pp_gt_g, 
           group=interaction(mod,rep_id),
           linetype=interaction(outcome,rep_id))) + 
  geom_line(aes(color=mod))



ggplot(data=subset(bb_pp_dat,rho_2==0.35 & n==50 & outcome=="e"), 
       aes(x=g, y=pp_gt_g, color=mod, group=interaction(mod,rep_id))) + 
  geom_line(alpha=0.5) + facet_grid(p_e2~p_s2,labeller = "label_both")

ggplot(data=subset(bb_pp_dat,rho_2==0.35 & n==50 & outcome=="s"), 
       aes(x=g, y=pp_gt_g, color=mod, group=interaction(mod,rep_id))) + 
  geom_line(alpha=0.5) + facet_grid(p_e2~p_s2,labeller = "label_both")

plot_grid(g1,g2)



g3<-ggplot(data=subset(bb_pp_dat,rho_2==0.35 & n==200 & mod=="i"), 
       aes(x=g, y=pp_gt_g, color=outcome, group=interaction(outcome,rep_id))) + 
  geom_line(alpha=0.5) + facet_grid(p_e2~p_s2,labeller = "label_both") + theme(legend.position = "none", axis.text.x= element_text(size=10))

g4<-ggplot(data=subset(bb_pp_dat,rho_2==0.35 & n==200 & mod=="j"), 
       aes(x=g, y=pp_gt_g, color=outcome, group=interaction(outcome,rep_id))) + 
  geom_line(alpha=0.5) + facet_grid(p_e2~p_s2,labeller = "label_both") + theme(axis.text.x= element_text(size=10))

g5<-plot_grid(g3,g4,labels=c("ind models","copula model"), rel_widths=c(1,1.4), scale=0.85,label_size=11, label_x=0.4)  

# now add the title
title <- ggdraw() + 
  draw_label("posterior prob. of (eff>g) and posterior prob. of (safety>g)",
             fontface = 'bold')
g6<-plot_grid(title, g5, ncol = 1, rel_heights = c(0.1, 1)) 


save_plot("bb_pp_r035_n200.png",g6,base_height=5,base_width=10)

ggplot(data=subset(bb_pp_dat,rho_2==0.35 & n==50), aes(x=g, y=pp_gt_g, group=rep_id)) + geom_line(aes(col=mod)) + facet_grid(outcome+p_e2~p_s2,labeller = "label_both")

```

## Plots of joint posterior prob greater than g

```{r bb-pp-jnt-plt-summ, fig.align="center"}
bb_pp_jnt_dat_cln <- bb_pp_jnt_dat %>% mutate(delta_e=p_e2-p_e1, delta_s=p_s2-p_s1, 
                      model = factor(mod,c("i","j"), c("independent","copula")) ) %>%
                  select(-c(dat_seed,samp_seed,mod,p_e2,p_s2,jnt)) 

bb_pp_jnt_dat_summ <- bb_pp_jnt_dat_cln %>% 
  arrange(scn_id, model, g) %>%
  group_by(scn_id, model, g) %>%
  summarise(mean_pp_gt_g = mean(pp_gt_g), n=mean(n), rho_2=mean(rho_2), delta_e=mean(delta_e),delta_s=mean(delta_s))

if (0){
ggplot(data=subset(bb_pp_jnt_dat_summ,scn_id==72), 
       aes(x=g, y=mean_pp_gt_g, color=model, group=model)) +  geom_line(alpha=0.6) 

ggplot(data=subset(bb_pp_jnt_dat_summ,scn_id==1), 
       aes(x=g, y=mean_pp_gt_g, color=model, group=model)) +  geom_line(alpha=0.6) 

ggplot(data=subset(bb_pp_jnt_dat_summ, rho_2==0.1 & n==100), 
       aes(x=g, y=mean_pp_gt_g, color=model, group=model )) + 
  geom_line(alpha=0.6) + facet_grid(delta_e~delta_s,labeller = "label_both")
}

# get difference in posterior prob of being greater than g for eff and safety
sub1_pp_jnt_dat_summ<-subset(bb_pp_jnt_dat_summ, model=="independent") %>% rename(mn_pp_gt_g_i=mean_pp_gt_g)
sub2_pp_jnt_dat_summ<-subset(bb_pp_jnt_dat_summ, model=="copula") %>% rename(mn_pp_gt_g_j=mean_pp_gt_g)


bb_pp_jnt_dat_summ_diff<-merge(sub1_pp_jnt_dat_summ, sub2_pp_jnt_dat_summ, by=c("scn_id", "g", "n", "rho_2", "delta_e", "delta_s")) %>% mutate(mn_pp_gt_g_diff=mn_pp_gt_g_i-mn_pp_gt_g_j)

if (0){
  # difference is ind mod - copula model, so >0 means ind model has higher post. prob of being > g
ggplot(data=subset(bb_pp_jnt_dat_summ_diff, rho_2==0.1 & n==100), 
       aes(x=g, y=mn_pp_gt_g_diff)) + 
  geom_line(alpha=0.2) + facet_grid(delta_e~delta_s,labeller = "label_both")

ggplot(data=subset(bb_pp_jnt_dat_summ_diff, rho_2==0.1), 
       aes(x=g, y=mn_pp_gt_g_diff, color=factor(n), group=factor(n))) + 
  geom_line(alpha=0.8) + facet_grid(delta_e~delta_s,labeller = "label_both")

ggplot(data=subset(bb_pp_jnt_dat_summ_diff, n==100), 
       aes(x=g, y=mn_pp_gt_g_diff, color=factor(rho_2), group=factor(rho_2))) + 
  geom_line(alpha=0.8) + facet_grid(delta_e~delta_s,labeller = "label_both")
}

ggplot(data=subset(bb_pp_jnt_dat_summ_diff, rho_2==0.1 & n==100), 
       aes(x=mn_pp_gt_g_i, y=mn_pp_gt_g_j)) + 
  geom_line(alpha=0.5) + facet_grid(delta_e~delta_s,labeller = "label_both")  +
  ggtitle("Mean posterior prob. of (p_eff>g and p_safety>g)", subtitle="joint copula model vs. independent models, rho_2, n=100") +
  xlab("mean PP of p_eff>g and p_safety>g (independent model)") +
  ylab("mean PP of p_eff>g and p_safety>g (copula model)")


ggplot(data=subset(bb_pp_jnt_dat_summ_diff, n==200), 
       aes(x=mn_pp_gt_g_i, y=mn_pp_gt_g_j, color=factor(rho_2), group=factor(rho_2))) + 
  geom_line(alpha=0.5) + facet_grid(delta_e~delta_s,labeller = "label_both")  +
  ggtitle("Mean posterior prob. of (p_eff>g and p_safety>g) > g", subtitle="joint copula model vs. independent models, n=200") +
  xlab("mean PP of p_eff>g and p_safety>g (independent model)") +
  ylab("mean PP of p_eff>g and p_safety>g (copula model)")
```


```{r bb-pp-jnt-plt}

# specific simulation scenarios
if (0){
ggplot(data=subset(bb_pp_jnt_dat,scn_id==72), 
       aes(x=g, y=pp_gt_g, color=mod, group=interaction(mod,rep_id))) + 
  geom_line(alpha=0.5) 

ggplot(data=subset(bb_pp_jnt_dat,scn_id==1), 
       aes(x=g, y=pp_gt_g, color=mod, group=interaction(mod,rep_id))) + 
  geom_line(alpha=0.5) 
}

p1 <- ggplot(data=subset(bb_pp_jnt_dat, rho_2==0.1 & n==100), 
       aes(x=g, y=pp_gt_g, color=mod, group=interaction(mod,rep_id))) + 
  geom_line(alpha=0.2) + facet_grid(p_e2~p_s2,labeller = "label_both")


p2 <- ggplot(data=subset(bb_pp_jnt_dat, rho_2==0.35 & n==100), 
       aes(x=g, y=pp_gt_g, color=mod, group=interaction(mod,rep_id))) + 
  geom_line(alpha=0.2) + facet_grid(p_e2~p_s2,labeller = "label_both") + 
  ggtitle("joint posterior prob. of (eff>g and safety>g) for ind vs. copula models")

png(file.path(figdir,"bb_pp_jnt_r035_n100.png"),width=720,height=720)
p2
dev.off()

p3<-ggplot(data=subset(bb_pp_jnt_dat, rho_2==0.6 & n==100), 
       aes(x=g, y=pp_gt_g, color=mod, group=interaction(mod,rep_id))) + 
  geom_line(alpha=0.2) + facet_grid(p_e2~p_s2,labeller = "label_both")

# get difference in posterior prob of being greater than g for eff and safety
sub1<-subset(bb_pp_jnt_dat,mod=="i")
sub2<-subset(bb_pp_jnt_dat,mod=="j")

sub1 %<>% rename(pp_gt_g_i=pp_gt_g)
sub2 %<>% rename(pp_gt_g_j=pp_gt_g)

#merge on sim_id and g

bb_pp_jnt_dat2<-merge(sub1,sub2,by=c("sim_id","g","n","rho_2","p_e2","p_s2","rep_id","scn_id")) %>% select(sim_id,g,n,rho_2,p_e2,p_s2,rep_id,scn_id,g,pp_gt_g_i,pp_gt_g_j) %>% mutate(pp_gt_g_diff=pp_gt_g_i-pp_gt_g_j)

p4 <- ggplot(data=subset(bb_pp_jnt_dat2, rho_2==0.1 & n==100), 
       aes(x=g, y=pp_gt_g_diff, group=rep_id)) + 
  geom_line(alpha=0.2) + facet_grid(p_e2~p_s2,labeller = "label_both")


p5 <- ggplot(data=subset(bb_pp_jnt_dat2, rho_2==0.35 & n==100), 
       aes(x=g, y=pp_gt_g_diff, group=rep_id)) + 
  geom_line(alpha=0.2) + facet_grid(p_e2~p_s2,labeller = "label_both") + ggtitle("difference in joint PP of (eff>g and safety>g) for ind vs. copula models")

# difference is ind mod - copula model, so >0 means ind model has higher post. prob of being > g
png(file.path(figdir,"bb_pp_jnt_diff_r035_n100.png"),width=720,height=720)
p5
dev.off()

p6<-ggplot(data=subset(bb_pp_jnt_dat2, rho_2==0.6 & n==100), 
       aes(x=g, y=pp_gt_g_diff, group=rep_id)) + 
  geom_line(alpha=0.2) + facet_grid(p_e2~p_s2,labeller = "label_both")
```


## Plots of probability of technical success

The probability of technical success (POTS) is the posterior probability of that difference between treatment and control is simultaneously larger than a given efficacy threshold ($\Delta_{E}$) AND smaller than a given safety threshold ($\Delta_{S}$). In simpler terms, "Given the data and our prior knowledge, what is the probability that the treatment is both effective and safe?"

The plot below shows the difference between the POTS fit with an independence assumption and the POTS under the correctly specified joint copula model to contrast the two modeling approaches. Areas in blue indicate that the independence model estimates are too low and areas in red indicate that the independence model estimates are too high.

```{r bb-pots-plt, fig.align="center"}

bb_pots_dat_cln <- bb_pots_dat %>% mutate(delta_e=p_e2-p_e1, delta_s=p_s2-p_s1, 
                      model = factor(mod,c("i","j"), c("independent","copula")) ) %>%
                  select(-c(dat_seed,samp_seed,mod,p_e2,p_s2)) 

bb_pots_dat_summ <- bb_pots_dat_cln %>% 
  arrange(scn_id, model, g_e, g_s) %>%
  group_by(scn_id, model, g_e, g_s) %>%
  summarise(mn_pots = mean(pots_g), n=mean(n), rho_2=mean(rho_2), delta_e=mean(delta_e),delta_s=mean(delta_s))

# colors for pots
num_cols<-20
pots_col <-rev(rainbow(20, start = 0/6, end = 4/6))

# see https://stackoverflow.com/questions/23908114/creating-a-colour-gradient-around-zero-in-filled-contour
myFilled.contour <- function(x = seq(0, 1, length.out = nrow(z)),
                             y = seq(0, 1, length.out = ncol(z)),
                             z, nlevels=30, ...) {
  ma <- max(abs(z))
  lvls <- seq(-ma, ma, length.out = nlevels)
  cols <- colorRampPalette(c("blue","white","red")) (nlevels - 1)
  filled.contour(x, y, z, plot.axes={axis(1); axis(2)},
                 col=cols, levels=lvls, ...)
}

# plot pots for given scenario id
plot_pots<-function(id, num){
zvec_i <- unlist(subset(bb_pots_dat_summ, scn_id==id & model=="independent", select=c("mn_pots")))

zvec_j <- unlist(subset(bb_pots_dat_summ, scn_id==id & model=="copula", select=c("mn_pots")))

zvec_chg <- zvec_i - zvec_j #independent minus joint model estimates
  
zmat_i <- matrix(zvec_i, nrow=length(g_seq))
zmat_j <- matrix(zvec_j, nrow=length(g_seq))
zmat_chg <- matrix(zvec_chg, nrow=length(g_seq))

if (num==1){
# ind. models
filled.contour(g_seq, g_seq, z=t(zmat_i), col = pots_col, 
               key.title=title(main = "Posterior \nProbability (%)", cex.main=0.7), 
               xlab=expression(Delta[E]), ylab=expression(Delta[S]), plot.axes = {contour(g_seq,g_seq,t(zmat_i), labcex=1.1, nlevels=6, add=TRUE,vfont =c("sans serif", "bold"));axis(1);axis(2)} )
} else if (num==2){
# joint model  
filled.contour(g_seq, g_seq, z=t(zmat_j), col = pots_col, 
               key.title=title(main = "Posterior \nProbability (%)", cex.main=0.7), 
               xlab=expression(Delta[E]), ylab=expression(Delta[S]), plot.axes = {contour(g_seq,g_seq,t(zmat_j), labcex=1.1, nlevels=6, add=TRUE,vfont =c("sans serif", "bold"));axis(1);axis(2)} )
} else {
# difference between ind. and joint models
myFilled.contour(g_seq, g_seq, z=t(zmat_chg), 
               key.title=title(main = "Diff. in \nPosterior \nProbability (%)",
                               cex.main=0.7), 
               xlab=expression(Delta[E]), ylab=expression(Delta[S]))
}
}

# number of reps under each simulation scenario
#table(bb_sim_array_ord_run$scn_id)

scn_ids_uniq<-bb_sim_array_ord_run %>% mutate(delta_e=p_e2-p_e1, delta_s=p_s2-p_s1) %>%
  select(n,rho_2,delta_e,delta_s,scn_id) %>% unique()

# look at the scenario IDs that have certain criteria/parameters
#scn_ids_uniq %>% filter(n==200 & delta_e>0 & delta_s>0)

png(file.path(figdir,"bb_pots_r035_plt1.png"), width=900, height=600, pointsize=20)
plot_pots(69,1) # <--
dev.off()

png(file.path(figdir,"bb_pots_r035_plt2.png"), width=900, height=600, pointsize=20)
plot_pots(69,2) # <--
dev.off()

png(file.path(figdir,"bb_pots_r035_plt3.png"), width=900, height=600, pointsize=20)
plot_pots(69,3) # <--
dev.off()

plot_pots(78,3) # <--

```

## Plots of correlation between posterior parameter distributions
```{r bb-corr-plt}

ggplot(data=subset(bb_corr_dat,scn_id==72), aes(x=corr, fill=mod)) + geom_density()

ggplot(data=subset(bb_corr_dat,rho_2==0.35 & n==100),aes(x=corr, fill=mod)) +  geom_density( alpha=0.1) + facet_grid(p_e2~p_s2,labeller = "label_both")

ggplot(data=subset(bb_corr_dat,p_e2==0.2 & p_s2==0.1),aes(x=corr, y=mod)) +  geom_violinh(alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

if (0){
ggplot(data=subset(bb_corr_dat,p_e2==0.2 & p_s2==0.1),aes(x=corr, fill=mod)) +  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

ggplot(data=subset(bb_corr_dat,p_e2==0.2 & p_s2==0.4),aes(x=corr, fill=mod)) +  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

ggplot(data=subset(bb_corr_dat,p_e2==0.2 & p_s2==0.7),aes(x=corr, fill=mod)) +  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

ggplot(data=subset(bb_corr_dat,p_e2==0.5 & p_s2==0.1),aes(x=corr, fill=mod)) +  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

ggplot(data=subset(bb_corr_dat,p_e2==0.5 & p_s2==0.4),aes(x=corr, fill=mod)) +  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

ggplot(data=subset(bb_corr_dat,p_e2==0.5 & p_s2==0.7),aes(x=corr, fill=mod)) +  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

ggplot(data=subset(bb_corr_dat,p_e2==0.8 & p_s2==0.1),aes(x=corr, fill=mod)) +  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

ggplot(data=subset(bb_corr_dat,p_e2==0.8 & p_s2==0.4),aes(x=corr, fill=mod)) +  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

ggplot(data=subset(bb_corr_dat,p_e2==0.8 & p_s2==0.7),aes(x=corr, fill=mod)) +  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")
}


if (1){

pl1 <- ggplot(data=subset(bb_corr_dat,p_e2==0.2 & p_s2==0.1 & n==100),aes(x=corr, fill=mod)) +  
    geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

pl2 <-ggplot(data=subset(bb_corr_dat,p_e2==0.2 & p_s2==0.4 & n==100),aes(x=corr, fill=mod)) +  
  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

pl3 <-ggplot(data=subset(bb_corr_dat,p_e2==0.2 & p_s2==0.7 & n==100),aes(x=corr, fill=mod)) +  
  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

pl4 <-ggplot(data=subset(bb_corr_dat,p_e2==0.5 & p_s2==0.1 & n==100),aes(x=corr, fill=mod)) +  
  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

pl5 <-ggplot(data=subset(bb_corr_dat,p_e2==0.5 & p_s2==0.4 & n==100),aes(x=corr, fill=mod)) +  
  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

pl6 <-ggplot(data=subset(bb_corr_dat,p_e2==0.5 & p_s2==0.7 & n==100),aes(x=corr, fill=mod)) +  
  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

pl7 <-ggplot(data=subset(bb_corr_dat,p_e2==0.8 & p_s2==0.1 & n==100),aes(x=corr, fill=mod)) +  
  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

pl8 <-ggplot(data=subset(bb_corr_dat,p_e2==0.8 & p_s2==0.4 & n==100),aes(x=corr, fill=mod)) +  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")

pl9 <-ggplot(data=subset(bb_corr_dat,p_e2==0.8 & p_s2==0.7& n==100),aes(x=corr, fill=mod)) +  geom_density( alpha=0.1) + facet_grid(n~rho_2,labeller = "label_both")
}


png(file.path(figdir,"bb_corr_pe2_02_p_s2_01_n100.png"),width=720,height=720)
pl1
dev.off()  
  

png(file.path(figdir,"bb_corr_pe2_05_p_s2_04_n100.png"),width=720,height=720)
pl5
dev.off()

```
